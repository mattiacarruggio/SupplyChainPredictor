// Prisma Schema for Supply Chain Risk & Disruption Predictor
// This schema defines the data model for tracking suppliers, products, locations,
// shipment routes, risk events, inventory, and users in a multi-tenant environment.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =======================
// Core Entities
// =======================

model Supplier {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")
  code         String   @unique
  name         String
  country      String
  contactEmail String?  @map("contact_email")
  contactPhone String?  @map("contact_phone")
  address      String?
  rating       Int      @default(3)
  notes        String?  @db.Text

  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  products     Product[]
  riskEvents   RiskEventSupplier[]

  @@index([tenantId])
  @@index([country])
  @@index([rating])
  @@map("suppliers")
}

model Product {
  id             String   @id @default(uuid())
  tenantId       String   @map("tenant_id")
  sku            String   @unique
  name           String
  description    String?  @db.Text
  category       String
  unitOfMeasure  String   @default("unit") @map("unit_of_measure")
  leadTimeDays   Int      @map("lead_time_days")

  supplierId     String   @map("supplier_id")
  supplier       Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  inventory      Inventory[]
  riskEvents     RiskEventProduct[]

  @@index([tenantId])
  @@index([supplierId])
  @@index([category])
  @@map("products")
}

model Location {
  id            String   @id @default(uuid())
  tenantId      String   @map("tenant_id")
  code          String   @unique
  name          String
  type          LocationType
  address       String?
  city          String?
  state         String?
  country       String
  postalCode    String?  @map("postal_code")
  latitude      Decimal? @db.Decimal(10, 7)
  longitude     Decimal? @db.Decimal(10, 7)
  capacity      Int?
  status        LocationStatus @default(ACTIVE)

  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  inventory            Inventory[]
  routesAsOrigin       ShipmentRoute[] @relation("OriginLocation")
  routesAsDestination  ShipmentRoute[] @relation("DestinationLocation")
  riskEvents           RiskEventLocation[]

  @@index([tenantId])
  @@index([type])
  @@index([country])
  @@index([status])
  @@map("locations")
}

model ShipmentRoute {
  id                    String   @id @default(uuid())
  tenantId              String   @map("tenant_id")

  originLocationId      String   @map("origin_location_id")
  originLocation        Location @relation("OriginLocation", fields: [originLocationId], references: [id], onDelete: Restrict)

  destinationLocationId String   @map("destination_location_id")
  destinationLocation   Location @relation("DestinationLocation", fields: [destinationLocationId], references: [id], onDelete: Restrict)

  transitTimeDays       Int      @map("transit_time_days")
  transportMode         TransportMode @map("transport_mode")
  distance              Decimal? @db.Decimal(10, 2)
  cost                  Decimal? @db.Decimal(12, 2)

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  riskEvents            RiskEventRoute[]

  @@index([tenantId])
  @@index([originLocationId])
  @@index([destinationLocationId])
  @@index([transportMode])
  @@unique([tenantId, originLocationId, destinationLocationId, transportMode], name: "unique_route")
  @@map("shipment_routes")
}

model RiskEvent {
  id              String   @id @default(uuid())
  tenantId        String   @map("tenant_id")
  eventType       EventType @map("event_type")
  severity        RiskSeverity
  status          RiskStatus @default(ACTIVE)

  startDate       DateTime @map("start_date")
  resolutionDate  DateTime? @map("resolution_date")

  title           String
  description     String   @db.Text
  impactAssessment String? @db.Text @map("impact_assessment")
  mitigationPlan  String?  @db.Text @map("mitigation_plan")

  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  suppliers       RiskEventSupplier[]
  products        RiskEventProduct[]
  locations       RiskEventLocation[]
  routes          RiskEventRoute[]

  @@index([tenantId])
  @@index([eventType])
  @@index([severity])
  @@index([status])
  @@index([startDate])
  @@map("risk_events")
}

model Inventory {
  id               String   @id @default(uuid())
  tenantId         String   @map("tenant_id")

  productId        String   @map("product_id")
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  locationId       String   @map("location_id")
  location         Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  quantityOnHand   Int      @default(0) @map("quantity_on_hand")
  quantityReserved Int      @default(0) @map("quantity_reserved")
  reorderPoint     Int      @default(0) @map("reorder_point")
  lastCountDate    DateTime? @map("last_count_date")

  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@unique([tenantId, productId, locationId], name: "unique_inventory")
  @@index([tenantId])
  @@index([productId])
  @@index([locationId])
  @@index([quantityOnHand])
  @@map("inventory")
}

model User {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  email       String   @unique
  name        String
  role        UserRole
  status      UserStatus @default(ACTIVE)
  lastLoginAt DateTime?  @map("last_login_at")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([tenantId])
  @@index([role])
  @@index([status])
  @@map("users")
}

// =======================
// Junction Tables for Many-to-Many Relationships
// =======================

model RiskEventSupplier {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")

  riskEventId  String   @map("risk_event_id")
  riskEvent    RiskEvent @relation(fields: [riskEventId], references: [id], onDelete: Cascade)

  supplierId   String   @map("supplier_id")
  supplier     Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([riskEventId, supplierId])
  @@index([tenantId])
  @@map("risk_event_suppliers")
}

model RiskEventProduct {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")

  riskEventId  String   @map("risk_event_id")
  riskEvent    RiskEvent @relation(fields: [riskEventId], references: [id], onDelete: Cascade)

  productId    String   @map("product_id")
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([riskEventId, productId])
  @@index([tenantId])
  @@map("risk_event_products")
}

model RiskEventLocation {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")

  riskEventId  String   @map("risk_event_id")
  riskEvent    RiskEvent @relation(fields: [riskEventId], references: [id], onDelete: Cascade)

  locationId   String   @map("location_id")
  location     Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([riskEventId, locationId])
  @@index([tenantId])
  @@map("risk_event_locations")
}

model RiskEventRoute {
  id           String   @id @default(uuid())
  tenantId     String   @map("tenant_id")

  riskEventId  String   @map("risk_event_id")
  riskEvent    RiskEvent @relation(fields: [riskEventId], references: [id], onDelete: Cascade)

  routeId      String   @map("route_id")
  route        ShipmentRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now()) @map("created_at")

  @@unique([riskEventId, routeId])
  @@index([tenantId])
  @@map("risk_event_routes")
}

// =======================
// Enums
// =======================

enum LocationType {
  WAREHOUSE
  FACTORY
  DISTRIBUTION_CENTER
  PORT
  SUPPLIER_SITE
}

enum LocationStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

enum TransportMode {
  AIR
  SEA
  RAIL
  TRUCK
  MULTIMODAL
}

enum EventType {
  WEATHER
  POLITICAL
  SUPPLIER_FAILURE
  DEMAND_SURGE
  TRANSPORTATION_DISRUPTION
  QUALITY_ISSUE
  REGULATORY_CHANGE
  NATURAL_DISASTER
  LABOR_STRIKE
  CYBER_ATTACK
}

enum RiskSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum RiskStatus {
  ACTIVE
  MONITORING
  MITIGATED
  RESOLVED
}

enum UserRole {
  ADMIN
  ANALYST
  VIEWER
  PLANNER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}
